<!DOCTYPE html>
<html>
<head>
<meta name="viewport" content="initial-scale=1.0, user-scalable=no" />
<meta charset="UTF-8">
<style type="text/css">
    html {
        height: 100%
    }
    body {
        height: 100%;
        margin: 0;
        padding: 0
    }
    #map_canvas {
        height: 100%;
    }
    #map_panel {
        position: absolute;
        bottom: 0px;
        left: 0px;
        z-index: 10;
        border: 1px solid #777;
        background: #fff;
        height: 40%;
        width: 30%;
    }
</style>
<script type="text/javascript" src='http://maps.googleapis.com/maps/api/js?key=AIzaSyDc3LDO-rPImnz9e4c2KwviMBBRonz9vlk&sensor=false&libraries=drawing,geometry'></script>
<script type="text/javascript" src='https://www.google.com/jsapi'></script>
<script type="text/javascript">
    var map = null;
    var chart = null;
    var elevator = null;
    var track = [];
    var segments = [];
    var units = 'miles';
    var SAMPLES = 256;
    var start, end, handle, marker;

    google.load("visualization", "1", {packages:["corechart"]});

    function init() {
        var usa = new google.maps.LatLng(37.0625,-95.677068);
        var m_opts = {
            center: usa,
            zoom: 4,
            mapTypeId: google.maps.MapTypeId.ROADMAP,
            draggableCursor: 'pointer'
        };
        map = new google.maps.Map(document.getElementById("map_canvas"),m_opts);
        elevator = new google.maps.ElevationService();
        chart = new google.visualization.LineChart(document.getElementById('chart'));

        handle_img = new google.maps.MarkerImage("http://maps.gstatic.com/mapfiles/markers2/dd-via.png", null, null, new google.maps.Point(5, 5));


        google.maps.event.addListener(map, 'click', add_segment);
//        google.visualization.events.addListener(chart, 'onmouseover',
//            function(event) {
//                if (marker == null) {
//                    marker = new google.maps.Marker({
//                        position: elevations[event.row].location,
//                        map: map,
//                        icon: "http://maps.google.com/mapfiles/ms/icons/green-dot.png"
//                    });
//                } else {
//                    marker.setPosition(elevations[event.row].location);
//                }
//        });

    }

    function add_segment(event) {
        var segment;
        var handle;

        handle = new google.maps.Marker({
            raiseOnDrag: false,
            position: event.latLng,
            draggable: true,
            map: map,
            icon: handle_img
            });
        google.maps.event.addListener(handle, 'drag', drag(track.length));

        if (track.length > 0) {
            segment = new google.maps.Polyline({
                strokeColor: "#000000",
                strokeOpacity: .7,
                strokeWeight: 3,
                map: map,
                path: [track[track.length - 1].getPosition(), event.latLng]
            });
            segments.push(segment);
        }

        track.push(handle);
        update_all();
    }

    function drag(index) {
        return function () {
            var neighbor = null;
            var seg = null;

            if (index > 0) { // if index has a left neighbor
                seg = segments[index - 1];
                segments[index - 1].setPath([track[index - 1].getPosition(),
                    track[index].getPosition()]);
            }

            if (index < track.length - 1) { // if index has a right neighbor
                seg = segments[index];
                segments[index].setPath([track[index].getPosition(),
                    track[index + 1].getPosition()]);
            }
            update_all();
            return;
        }
    }

    function remove_segment(event) {
        del = track.pop();
        del.setMap(null);
        del = null;

        del = segments.pop();
        del.setMap(null);
        del = null;

        update_all();
    }

    function plot_elevation(results) {
        if (results == null)
            return;

        elevations = results;

        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Sample');
        data.addColumn('number', 'Elevation');
        for (var i = 0; i < results.length; i++) {
            data.addRow(['', elevations[i].elevation]);
        }

        document.getElementById('chart').style.display = 'block';
        chart.draw(data, {
            legend: 'none',
            titleY: 'Elevation (m)',
            focusBorderColor: '#00ff00'
        });
    }

    function update_elevation() {
        if (track.length > 1)
            elevator.getElevationAlongPath({ 'path': get_latLngs(),
                                            'samples': 256 },
                    plot_elevation);
    }

    function get_latLngs() {
        return track.map(function (handle) { return handle.getPosition(); });
    }

    function update_distance() {
        if (track == [])
            return;

        var dist = google.maps.geometry.spherical.computeLength(get_latLngs()); 
        document.getElementById("length").innerHTML = unit(dist).toFixed(2);
    }

    function update_all() {
        update_elevation();
        update_distance();
    }

    function unit(dist) {
        document.getElementById("unit").innerHTML = units;
        switch (units) {
        case "miles": return (dist * 0.000621371192);
        case "km": return (dist * 0.001);
        case "ft": return (dist * 3.2808399);
        }
    }

    function set_units(u) {
        units = u;
        update_distance();
    }

    function undo() {
        remove_segment();
    }

    function clear_path() {
        var i;

        for (i = 0; i < track.length; i++) {
            track[i].setMap(null);
            track[i] = null;
        }

        for (i = 0; i < segments.length; i++) {
            segments[i].setMap(null);
            segments[i] = null;
        }

        track = [];
        segments = [];

        var data = new google.visualization.DataTable();
        data.addColumn('string', 'Sample');
        data.addColumn('number', 'Elevation');

        document.getElementById('chart').style.display = 'block';
        chart.draw(data, {
            legend: 'none',
            titleY: 'Elevation (m)',
            focusBorderColor: '#00ff00'
        });

        update_all();
    }
</script>


<title>Tracks</title>
</head>
<body onload="init()">
<div id="map_canvas" style="width:100%; height:100%"> </div>
<div id="map_panel">
<a href="javascript:undo()">
<span style="text-decoration:underline">Undo</span>
</a> &nbsp;

<a href="javascript:clear_path()">
<span style="text-decoration:underline">Clear</span>
</a> &nbsp;

<a href="javascript:permalink()">
<img src="http://maps.google.com/mapfiles/link_icon.gif"/>
<span style="text-decoration:underline">Link to this page</span>
</a>
<br /><br />

<div style="width:200px;margin:0 0 15px 0">
Click the map to mark points on your path.
</div>

<span style="font-weight: bold">Path length</span> &nbsp;
<span style="font-size: 10pt;">[
<a href="javascript:set_units('miles')">miles</a> |
<a href="javascript:set_units('ft')">ft</a> |
<a href="javascript:set_units('km')">km</a>
]</span><br />
&nbsp; <span id="length">0.00</span> <span id="unit">miles</span><br />

<div id="chart" style="width: 100%; height:65%;"></div>

<div id="error"></div>
</div>
</body>
</html>
